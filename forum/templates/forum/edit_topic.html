{% extends 'base.html' %}
{% load forum_tags %}
{% include 'forum/components/sidebar.html' %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-6">

  <!-- Header -->
  <div class="bg-white/80 backdrop-blur-sm rounded-xl border border-gray-200/50 card-shadow p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold text-transparent bg-clip-text gradient-bg flex items-center">
        <i class="fas fa-edit mr-3 text-primary-600"></i>
        Konu Düzenle
        {% if topic.is_locked %}
          <span class="ml-3 text-red-600 text-sm font-normal">
            <i class="fas fa-lock"></i>
            Kilitli Konu
          </span>
        {% endif %}
      </h1>
      <a href="{% url 'topic_detail' topic.slug %}"
         class="text-gray-600 hover:text-primary-600 transition-colors flex items-center">
        <i class="fas fa-arrow-left mr-2"></i>
        Konuya Dön
      </a>
    </div>
    
    <div class="flex items-center justify-between">
      <p class="text-gray-600">
        {% if topic.is_locked and not user.is_staff %}
          Bu konu kilitlenmiştir. Sadece yöneticiler düzenleyebilir.
        {% else %}
          Mevcut konunuzu güncelleyin ve değişikliklerinizi kaydedin
        {% endif %}
      </p>
      
      <!-- Status badges -->
      <div class="flex items-center space-x-2">
        {% if topic.is_locked %}
          <span class="px-2 py-1 text-xs bg-red-100 text-red-700 rounded-full">
            <i class="fas fa-lock mr-1"></i>
            Kilitli
          </span>
        {% endif %}
        {% if topic.is_solved %}
          <span class="px-2 py-1 text-xs bg-green-100 text-green-700 rounded-full">
            <i class="fas fa-check-circle mr-1"></i>
            Çözüldü
          </span>
        {% endif %}
        {% if topic.is_edited %}
          <span class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded-full">
            <i class="fas fa-edit mr-1"></i>
            Düzenlenmiş
          </span>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Locked Topic Warning for Non-Staff -->
  {% if topic.is_locked and not user.is_staff %}
    <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded-lg">
      <div class="flex items-center text-red-700">
        <i class="fas fa-lock mr-2"></i>
        <div>
          <p class="font-semibold">Bu konu kilitlenmiştir</p>
          <p class="text-sm mt-1">Kilitli konular sadece yöneticiler tarafından düzenlenebilir. Bu sayfaya erişim yetkiniz bulunmamaktadır.</p>
        </div>
      </div>
    </div>
    
    <!-- Redirect button for locked topics -->
    <div class="text-center">
      <a href="{% url 'topic_detail' topic.slug %}" 
         class="inline-flex items-center px-6 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
        <i class="fas fa-arrow-left mr-2"></i>
        Konuya Geri Dön
      </a>
    </div>
  {% else %}
    <!-- Admin Lock Warning -->
    {% if topic.is_locked and user.is_staff %}
      <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6 rounded-lg">
        <div class="flex items-center text-yellow-700">
          <i class="fas fa-user-shield mr-2"></i>
          <div>
            <p class="font-semibold">Yönetici Yetkisi</p>
            <p class="text-sm mt-1">Bu konu kilitli, ancak yönetici yetkileriniz ile düzenleyebilirsiniz.</p>
          </div>
        </div>
      </div>
    {% endif %}

    <!-- Form Errors -->
    {% if form.non_field_errors %}
      <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded-lg">
        {% for error in form.non_field_errors %}
          <div class="flex items-center text-red-700">
            <i class="fas fa-exclamation-circle mr-2"></i>
            {{ error }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Form -->
    <form method="post" enctype="multipart/form-data" class="space-y-6" id="editTopicForm">
      {% csrf_token %}
      
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Main Form Content -->
        <div class="lg:col-span-2 space-y-6">
          
          <!-- Title -->
          <div class="bg-white/80 backdrop-blur-sm rounded-xl border border-gray-200/50 card-shadow p-6 {% if topic.is_locked %}opacity-75{% endif %}">
            <label class="block text-sm font-semibold text-gray-800 mb-3 flex items-center">
              <i class="fas fa-heading mr-2 text-primary-600"></i>
              Başlık
              {% if topic.is_locked %}
                <span class="ml-2 text-xs text-red-600">(Kilitli konu)</span>
              {% endif %}
            </label>
            {{ form.title
              |add_class:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200"
              |add_placeholder:"Başlık girin..."
              |set_required }}
            {% if form.title.errors %}
              <div class="mt-2 text-sm text-red-600 flex items-center">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                {{ form.title.errors.0 }}
              </div>
            {% endif %}
          </div>

          <!-- Content -->
          <div class="bg-white/80 backdrop-blur-sm rounded-xl border border-gray-200/50 card-shadow p-6 {% if topic.is_locked %}opacity-75{% endif %}">
            <label class="block text-sm font-semibold text-gray-800 mb-3 flex items-center">
              <i class="fas fa-align-left mr-2 text-secondary-600"></i>
              İçerik
              {% if topic.is_locked %}
                <span class="ml-2 text-xs text-red-600">(Kilitli konu)</span>
              {% endif %}
            </label>
            {{ form.content
              |add_class:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 resize-none"
              |add_attr:"rows:8"
              |add_placeholder:"Konunuzu detaylı bir şekilde açıklayın..."
              |set_required }}
            {% if form.content.errors %}
              <div class="mt-2 text-sm text-red-600 flex items-center">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                {{ form.content.errors.0 }}
              </div>
            {% endif %}
          </div>

          <!-- Current Media -->
          {% if topic.image or topic.video %}
          <div class="bg-white/80 backdrop-blur-sm rounded-xl border border-gray-200/50 card-shadow p-6 {% if topic.is_locked %}opacity-75{% endif %}">
            <label class="block text-sm font-semibold text-gray-800 mb-3 flex items-center">
              <i class="fas fa-images mr-2 text-accent-600"></i>
              Mevcut Medya
            </label>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              {% if topic.image %}
              <div class="relative bg-gray-50 rounded-lg p-3">
                <img src="{{ topic.image.url }}" alt="Mevcut fotoğraf" class="w-full h-40 object-cover rounded-lg cursor-pointer" onclick="openImageModal('{{ topic.image.url }}')">
                <div class="absolute top-5 right-5 bg-black/60 text-white px-2 py-1 rounded text-xs flex items-center">
                  <i class="fas fa-image mr-1"></i>Mevcut Fotoğraf
                </div>
                <div class="mt-2 flex items-center justify-between">
                  <span class="text-xs text-green-600 flex items-center">
                    <i class="fas fa-check-circle mr-1"></i>Aktif
                  </span>
                  <button type="button" onclick="removeCurrentMedia('image')" class="text-xs text-red-600 hover:text-red-700 flex items-center">
                    <i class="fas fa-trash mr-1"></i>Kaldır
                  </button>
                </div>
              </div>
              {% endif %}
              {% if topic.video %}
              <div class="relative bg-gray-50 rounded-lg p-3">
                <video controls class="w-full h-40 object-cover rounded-lg">
                  <source src="{{ topic.video.url }}" type="video/mp4">
                  Tarayıcınız video oynatmayı desteklemiyor.
                </video>
                <div class="absolute top-5 right-5 bg-black/60 text-white px-2 py-1 rounded text-xs flex items-center">
                  <i class="fas fa-video mr-1"></i>Mevcut Video
                </div>
                <div class="mt-2 flex items-center justify-between">
                  <span class="text-xs text-green-600 flex items-center">
                    <i class="fas fa-check-circle mr-1"></i>Aktif
                  </span>
                  <button type="button" onclick="removeCurrentMedia('video')" class="text-xs text-red-600 hover:text-red-700 flex items-center">
                    <i class="fas fa-trash mr-1"></i>Kaldır
                  </button>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}

          <!-- New Media Upload -->
          <div class="bg-white/80 backdrop-blur-sm rounded-xl border border-gray-200/50 card-shadow p-6 {% if topic.is_locked %}opacity-75{% endif %}">
            <label class="block text-sm font-semibold text-gray-800 mb-3 flex items-center">
              <i class="fas fa-upload mr-2 text-accent-600"></i>
              {% if topic.image or topic.video %}Medya Değiştir{% else %}Medya Yükle{% endif %}
              {% if topic.is_locked %}
                <span class="ml-2 text-xs text-red-600">(Kilitli konu)</span>
              {% endif %}
            </label>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- AJAX File Upload -->
              <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 hover:border-primary-400 transition-colors">
                <label class="block text-xs font-medium text-gray-600 mb-2 flex items-center">
                  <i class="fas fa-file-upload mr-2 text-primary-500"></i>
                  Dosya Seç
                </label>
                <input type="file" id="ajaxEditTopicFile" name="image" class="w-full text-sm text-gray-500">
                <button type="button" id="ajaxEditTopicUploadBtn"
                        class="mt-2 px-3 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                  Yükle
                </button>
                <div id="ajaxEditTopicPreview" class="mt-3">
                  {% if topic.image %}
                    <img src="{{ topic.image.url }}" class="h-32 rounded">
                  {% elif topic.video %}
                    <video src="{{ topic.video.url }}" controls class="h-32 rounded"></video>
                  {% endif %}
                </div>
                <!-- Hidden input (backend'e gönderilecek relative path) -->
                <input type="hidden" name="uploaded_file_path" id="uploadedEditTopicFilePath"
                      value="{% if topic.image %}{{ topic.image.name }}{% elif topic.video %}{{ topic.video.name }}{% endif %}">
              </div>
            </div>

            <p class="text-xs text-gray-500 mt-2">
              <i class="fas fa-info-circle mr-1"></i>
              Desteklenen formatlar: JPG, PNG, GIF (fotoğraf) | MP4, WebM (video) | Max 50MB
            </p>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
          
          <!-- Category -->
          <div class="bg-white/80 backdrop-blur-sm rounded-xl border border-gray-200/50 card-shadow p-6 {% if topic.is_locked %}opacity-75{% endif %}">
            <label class="block text-sm font-semibold text-gray-800 mb-3 flex items-center">
              <i class="fas fa-folder mr-2 text-primary-600"></i>
              Kategori
            </label>
            {{ form.category|add_class:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200" }}
            {% if form.category.errors %}
              <div class="mt-2 text-sm text-red-600 flex items-center">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                {{ form.category.errors.0 }}
              </div>
            {% endif %}
          </div>

          <!-- Tags -->
          <div class="bg-white/80 backdrop-blur-sm rounded-xl border border-gray-200/50 card-shadow p-6 {% if topic.is_locked %}opacity-75{% endif %}">
            <label class="block text-sm font-semibold text-gray-800 mb-3 flex items-center">
              <i class="fas fa-tags mr-2 text-secondary-600"></i>
              Etiketler
            </label>
            {{ form.tags|add_class:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200"|add_placeholder:"Etiketleri girin (virgülle ayırın)" }}
            {% if form.tags.errors %}
              <div class="mt-2 text-sm text-red-600 flex items-center">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                {{ form.tags.errors.0 }}
              </div>
            {% endif %}
          </div>

          <!-- Actions -->
          <div class="bg-white/80 backdrop-blur-sm rounded-xl border border-gray-200/50 card-shadow p-6">
            <div class="space-y-3">
              <button type="submit"
                      class="w-full gradient-bg text-white py-3 px-4 rounded-lg font-semibold hover:shadow-lg transition-all duration-300 flex items-center justify-center {% if topic.is_locked %}opacity-75{% endif %}"
                      id="submitBtn">
                <i class="fas fa-save mr-2"></i>
                <span id="submitText">
                  {% if topic.is_locked and user.is_staff %}
                    Kilitli Konuyu Kaydet
                  {% else %}
                    Değişiklikleri Kaydet
                  {% endif %}
                </span>
              </button>
              <a href="{% url 'topic_detail' topic.slug %}"
                 class="w-full block text-center py-3 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-all duration-200 flex items-center justify-center">
                <i class="fas fa-times mr-2"></i>
                İptal Et
              </a>
            </div>
          </div>

          <!-- Topic Info -->
          <div class="bg-gradient-to-r from-blue-50 to-cyan-100 rounded-xl border border-blue-200/50 p-6">
            <h3 class="text-sm font-semibold text-blue-800 mb-3 flex items-center">
              <i class="fas fa-info-circle mr-2"></i>
              Konu Bilgileri
            </h3>
            <div class="text-xs text-blue-700 space-y-2">
              <div class="flex justify-between">
                <span>Oluşturulma:</span>
                <span>{{ topic.date_created|date:"d.m.Y H:i" }}</span>
              </div>
              <div class="flex justify-between">
                <span>Görüntülenme:</span>
                <span>{{ topic.views|default:"0" }}</span>
              </div>
              <div class="flex justify-between">
                <span>Beğeni:</span>
                <span>{{ topic.likes.count|default:"0" }}</span>
              </div>
              <div class="flex justify-between">
                <span>Yorum:</span>
                <span>{{ topic.comments.count|default:"0" }}</span>
              </div>
              {% if topic.is_locked %}
              <div class="flex justify-between text-red-600">
                <span>Durum:</span>
                <span><i class="fas fa-lock mr-1"></i>Kilitli</span>
              </div>
              {% endif %}
              {% if topic.is_solved %}
              <div class="flex justify-between text-green-600">
                <span>Çözüm:</span>
                <span><i class="fas fa-check-circle mr-1"></i>Var</span>
              </div>
              {% endif %}
              {% if topic.is_edited %}
              <div class="flex justify-between">
                <span>Son düzenleme:</span>
                <span>{{ topic.updated_at|date:"d.m.Y H:i" }}</span>
              </div>
              {% endif %}
            </div>
          </div>

        </div>
      </div>
    </form>
  {% endif %}
</div>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50" onclick="closeImageModal()">
  <div class="max-w-4xl max-h-full p-4 relative">
    <img id="modalImage" src="" alt="" class="max-w-full max-h-full object-contain rounded-lg">
    <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white text-2xl hover:text-gray-300 bg-black bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center">
      <i class="fas fa-times"></i>
    </button>
  </div>
</div>

<script>
// CSRF helper
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
    // Only enable form functionality if topic is not locked or user is staff
    {% if not topic.is_locked or user.is_staff %}
    // --- AJAX Upload ---
    const fileInput = document.getElementById("ajaxEditTopicFile");
    const uploadBtn = document.getElementById("ajaxEditTopicUploadBtn");
    const preview = document.getElementById("ajaxEditTopicPreview");
    const hiddenPath = document.getElementById("uploadedEditTopicFilePath");

    if (uploadBtn) {
        uploadBtn.addEventListener("click", function () {
            const file = fileInput.files[0];
            if (!file) {
                alert("Lütfen dosya seçin!");
                return;
            }

            const formData = new FormData();
            formData.append("file", file);
            formData.append("type", "topic");

            fetch("{% url 'ajax_file_upload' %}", {
                method: "POST",
                body: formData,
                headers: { "X-CSRFToken": getCookie("csrftoken") }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    preview.innerHTML = file.type.startsWith("image/")
                        ? `<img src="${data.url}" class="h-32 rounded">`
                        : `<video src="${data.url}" controls class="h-32 rounded"></video>`;
                    
                    hiddenPath.value = data.path;
                } else {
                    alert("Yükleme hatası: " + data.error);
                }
            })
            .catch(err => console.error("Upload error", err));
        });
    }

    // --- Form submit ---
    const form = document.getElementById('editTopicForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');

    if (form) {
        form.addEventListener('submit', function() {
            submitBtn.disabled = true;
            submitText.textContent = '{% if topic.is_locked and user.is_staff %}Kilitli konu kaydediliyor...{% else %}Kaydediliyor...{% endif %}';
            submitBtn.querySelector('i').className = 'fas fa-spinner fa-spin mr-2';
        });
    }
    {% endif %}
});

// --- Modal fonksiyonları ---
function openImageModal(imageSrc) {
    document.getElementById('modalImage').src = imageSrc;
    document.getElementById('imageModal').classList.remove('hidden');
    document.getElementById('imageModal').classList.add('flex');
    document.body.style.overflow = 'hidden';
}

function closeImageModal() {
    document.getElementById('imageModal').classList.add('hidden');
    document.getElementById('imageModal').classList.remove('flex');
    document.body.style.overflow = 'auto';
}

function removeCurrentMedia(type) {
    if (!confirm(`Mevcut ${type === 'image' ? 'fotoğraf' : 'video'} silinecek. Emin misiniz?`)) {
        return;
    }

    fetch("{% url 'delete_topic_media' topic.id %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: "type=" + type
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showNotification(`${type === 'image' ? 'Fotoğraf' : 'Video'} başarıyla kaldırıldı.`, 'success');
            location.reload(); // sayfayı yenile
        } else {
            showNotification("Hata: " + data.error, 'error');
        }
    })
    .catch(err => {
        console.error(err);
        showNotification("Bir hata oluştu.", 'error');
    });
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white text-sm transition-all duration-300 ${
        type === 'info' ? 'bg-blue-500' : 
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 'bg-gray-500'
    }`;
    notification.textContent = message;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>
{% endblock %}