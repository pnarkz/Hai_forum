{% comment %}
Comment Card Component
Usage: {% include 'components/comment_card.html' with comment=comment user=user is_reply=False %}
Props:
- comment (required)
- user (required for action checks)
- is_reply (optional, default: false)
{% endcomment %}

<div class="comment-card {% if is_reply %}ml-8 mt-4{% else %}mb-6{% endif %}" id="comment-{{ comment.id }}">
  <div class="bg-white/90 backdrop-blur-sm rounded-lg border border-slate-200 p-6 card-shadow transition-all duration-300 hover:shadow-md">

    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center space-x-3">
        <!-- Avatar -->
        <div class="w-10 h-10 rounded-full gradient-bg text-white flex items-center justify-center font-semibold shadow-md">
          {{ comment.author.username|default:"?"|first|upper }}
        </div>

        <div>
          <!-- Kullanıcı adı, unvan, OP -->
          <div class="flex items-center space-x-2">
            <a href="{% url 'accounts:user_profile' username=comment.author.username %}"
               class="font-semibold text-slate-800 hover:text-blue-600 transition-colors">
              {{ comment.author.username|default:"Bilinmeyen" }}
            </a>

            {% if comment.author.profile and comment.author.profile.title %}
              <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                {{ comment.author.profile.title }}
              </span>
            {% endif %}

            {% if comment.is_author_op %}
              <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-gradient-to-r from-purple-100 to-pink-100 text-purple-700 border border-purple-200">
                <i class="fas fa-crown mr-1"></i> OP
              </span>
            {% endif %}
          </div>

          <!-- Zaman -->
          <div class="flex items-center space-x-2 text-sm text-slate-500 mt-1">
            <i class="far fa-clock text-xs"></i>
            <span>{{ comment.date_created|timesince }} önce</span>
            {% if comment.date_created != comment.updated_at %}
              <span class="text-slate-400">•</span>
              <span class="italic">düzenlendi</span>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Sağ üst dropdown ve çözüm rozeti -->
      <div class="flex items-center space-x-2">
        {% if comment.is_solution %}
          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-gradient-to-r from-green-100 to-emerald-100 text-green-700 border border-green-200">
            <i class="fas fa-check-circle mr-1"></i> Çözüm
          </span>
        {% endif %}

        <!-- Dropdown -->
        <div class="relative group">
          <button class="comment-menu-toggle p-2 rounded-lg hover:bg-slate-100 transition-colors"
                  type="button" aria-expanded="false" aria-controls="commentMenu-{{ comment.id }}">
            <i class="fas fa-ellipsis-v text-slate-400"></i>
          </button>

          <div id="commentMenu-{{ comment.id }}" class="comment-menu absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-slate-200 py-2 z-10 hidden" role="menu" aria-label="Comment menu">
            <a href="#" onclick="copyCommentLink('{{ request.build_absolute_uri }}#comment-{{ comment.id }}'); return false;" class="flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-slate-50" role="menuitem">
              <i class="fas fa-link mr-3"></i> Bağlantıyı Kopyala
            </a>

            {% if user.is_authenticated %}
              <a href="#" class="flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-slate-50" role="menuitem">
                <i class="fas fa-flag mr-3"></i> Şikayet Et
              </a>

              {% if user.id == comment.author.id or user.is_staff %}
                <hr class="my-2">
                <a href="{% url 'edit_comment' comment.id %}" class="flex items-center px-4 py-2 text-sm text-blue-600 hover:bg-blue-50" role="menuitem">
                  <i class="fas fa-edit mr-3"></i> Düzenle
                </a>
                <a href="{% url 'delete_comment' comment.id %}" class="flex items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50" role="menuitem">
                  <i class="fas fa-trash mr-3"></i> Sil
                </a>
              {% endif %}
            {% endif %}
          </div>
        </div>
      </div>
    </div>
      <!-- İçerik -->
      <div class="prose prose-slate max-w-none mb-4">
        {% if comment.content_html %}
          {{ comment.content_html|safe }}
        {% else %}
          <p class="whitespace-pre-wrap">{{ comment.content }}</p>
        {% endif %}
      </div>

      <!-- Medya -->
      {% if comment.image or comment.video %}
        <div class="mb-4 space-y-3">
          {% if comment.image %}
            <div>
              <img src="{{ comment.image.url }}" 
                  alt="Yorum görseli"
                  class="rounded-lg max-h-80 object-cover shadow-md">
            </div>
          {% endif %}
          {% if comment.video %}
            <div>
              <video controls class="rounded-lg max-h-80 shadow-md w-full">
                <source src="{{ comment.video.url }}">
                Tarayıcınız video oynatmayı desteklemiyor.
              </video>
            </div>
          {% endif %}
        </div>
      {% endif %}
    </div>

    <!-- Ekler -->
    {% if comment.attachments.exists %}
      <div class="mb-4">
        <h5 class="text-sm font-medium text-slate-700 mb-2">Ekler:</h5>
        <div class="flex flex-wrap gap-2">
          {% for attachment in comment.attachments.all %}
            <a href="{{ attachment.file.url }}" target="_blank" 
               class="inline-flex items-center px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm text-slate-700 transition-colors">
              <i class="fas fa-paperclip mr-2"></i> {{ attachment.name }}
            </a>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <!-- Footer -->
    <div class="flex items-center justify-between pt-4 border-t border-slate-100">
      <!-- Reactions -->
      <div class="flex items-center space-x-4">
        <button type="button"
                class="like-comment-btn flex items-center space-x-2 px-3 py-2 rounded-lg hover:bg-rose-50 text-slate-600 hover:text-rose-600 transition-all group"
                data-comment-id="{{ comment.id }}"
                aria-pressed="false"
                aria-label="Like comment">
          <i class="far fa-heart group-hover:fas"></i>
          <span class="like-count text-sm font-medium">{{ comment.likes.count|default:0 }}</span>
       </button>
        {% if user.is_authenticated and not is_reply %}
          <button type="button"
                  class="reply-comment-btn flex items-center space-x-2 px-3 py-2 rounded-lg hover:bg-blue-50 text-slate-600 hover:text-blue-600 transition-all"
                  data-comment-id="{{ comment.id }}"
                  aria-expanded="false"
                  aria-controls="replyForm-{{ comment.id }}">
            <i class="fas fa-reply"></i>
            <span class="text-sm font-medium">Yanıtla</span>
          </button>
        {% endif %}

        {% if user.id == comment.topic.author.id and not comment.is_solution and not comment.topic.is_solved %}
            <button type="button"
                    class="mark-solution-btn flex items-center space-x-2 px-3 py-2 rounded-lg hover:bg-green-50 text-slate-600 hover:text-green-600 transition-all"
                    data-comment-id="{{ comment.id }}"
                    aria-label="Mark as solution">
              <i class="fas fa-check-circle"></i>
              <span class="text-sm font-medium">Çözüm Olarak İşaretle</span>
            </button>
        {% endif %}
      </div>

      <!-- Sıra numarası -->
      {% if forloop %}
        <div class="text-sm text-slate-400">
          #{{ forloop.counter }}
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Yanıt formu -->
  {% if user.is_authenticated and not is_reply %}
    <div id="replyForm-{{ comment.id }}" class="hidden mt-4 ml-8" aria-live="polite" aria-label="Reply form for comment {{ comment.id }}">
      <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
        <form method="post" action="{% url 'reply_comment' comment.id %}">
          {% csrf_token %}
          <div class="mb-3">
            <label for="reply-content-{{ comment.id }}" class="block text-sm font-medium text-slate-700 mb-2">
              {{ comment.author.username }} kullanıcısına yanıt:
            </label>
            <textarea id="reply-content-{{ comment.id }}" name="content" rows="3"
                      class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
                      placeholder="Yanıtınızı yazın..."></textarea>
          </div>
          <div class="flex justify-end space-x-2">
            <button type="button"
                    class="cancel-reply-btn px-4 py-2 text-sm font-medium text-slate-600 bg-slate-200 rounded-lg hover:bg-slate-300 transition-colors"
                    data-comment-id="{{ comment.id }}">
              İptal
            </button>
            <button type="submit"
                    class="px-4 py-2 text-sm font-medium text-white gradient-bg rounded-lg hover:shadow-lg transition-all">
              Yanıtla
            </button>
          </div>
        </form>
      </div>
    </div>
  {% endif %}

  <!-- Yanıtlar -->
  {% if comment.replies.exists and not is_reply %}
    <div class="mt-4">
      {% for reply in comment.replies.all %}
        {% include 'components/comment_card.html' with comment=reply is_reply=True user=user %}
      {% endfor %}
    </div>
  {% endif %}
</div>
